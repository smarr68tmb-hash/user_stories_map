# Тестирование Фазы 1

Этот документ описывает процесс тестирования всех компонентов Фазы 1.

## Предварительные требования

1. Запущен PostgreSQL и Redis (через docker-compose или локально)
2. Backend запущен на порту 8000
3. Установлены все зависимости Python

## 1. Тестирование миграций Alembic

### Шаг 1: Проверка конфигурации

Убедитесь, что в `.env` файле установлен `DATABASE_URL`:
```bash
DATABASE_URL=postgresql://usm_user:usm_password@localhost:5432/usm_db
```

Или для SQLite (для разработки):
```bash
DATABASE_URL=sqlite:///./usm.db
```

### Шаг 2: Создание миграции

```bash
cd backend
alembic revision --autogenerate -m "Initial migration with users and auth"
```

### Шаг 3: Применение миграции

```bash
alembic upgrade head
```

### Шаг 4: Проверка таблиц

Подключитесь к БД и проверьте наличие таблиц:
```bash
# Для PostgreSQL
psql -U usm_user -d usm_db -c "\dt"

# Должны быть таблицы:
# - users
# - projects
# - activities
# - user_tasks
# - releases
# - user_stories
# - alembic_version
```

## 2. Тестирование аутентификации

### Автоматическое тестирование

Запустите скрипт тестирования:
```bash
cd backend
python test_auth.py
```

Скрипт проверит:
- ✅ Health check
- ✅ Readiness check
- ✅ Регистрацию пользователя
- ✅ Логин
- ✅ Получение информации о пользователе (/me)
- ✅ Защиту эндпоинтов (401 без токена)
- ✅ Получение списка проектов

### Ручное тестирование

#### 2.1 Регистрация

```bash
curl -X POST http://127.0.0.1:8000/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "testpass123",
    "full_name": "Test User"
  }'
```

Ожидаемый ответ: `201 Created` с данными пользователя

#### 2.2 Логин

```bash
curl -X POST http://127.0.0.1:8000/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=test@example.com&password=testpass123"
```

Ожидаемый ответ: `200 OK` с `access_token`

#### 2.3 Получение информации о пользователе

```bash
TOKEN="ваш_токен_здесь"
curl -X GET http://127.0.0.1:8000/me \
  -H "Authorization: Bearer $TOKEN"
```

Ожидаемый ответ: `200 OK` с данными пользователя

#### 2.4 Проверка защиты эндпоинтов

```bash
# Без токена - должно вернуть 401
curl -X GET http://127.0.0.1:8000/projects

# С токеном - должно вернуть 200
curl -X GET http://127.0.0.1:8000/projects \
  -H "Authorization: Bearer $TOKEN"
```

## 3. Тестирование изоляции данных

### 3.1 Создание проектов от разных пользователей

1. Зарегистрируйте двух пользователей:
   - `user1@example.com`
   - `user2@example.com`

2. Войдите как `user1` и создайте проект

3. Войдите как `user2` и попробуйте получить проект `user1`:
   ```bash
   # Должно вернуть 404, так как проект принадлежит другому пользователю
   curl -X GET http://127.0.0.1:8000/project/1 \
     -H "Authorization: Bearer $TOKEN_USER2"
   ```

4. Проверьте список проектов - каждый пользователь должен видеть только свои проекты

### 3.2 Тестирование CRUD операций

1. Создайте проект от `user1`
2. Попробуйте создать story от `user2` в проект `user1` - должно вернуть 404
3. Попробуйте обновить story от `user2` в проект `user1` - должно вернуть 404
4. Попробуйте удалить story от `user2` в проект `user1` - должно вернуть 404

## 4. Тестирование Rate Limiting

### 4.1 Тест лимита регистрации (5/минуту)

```bash
# Выполните 6 запросов подряд
for i in {1..6}; do
  curl -X POST http://127.0.0.1:8000/register \
    -H "Content-Type: application/json" \
    -d "{\"email\": \"test$i@example.com\", \"password\": \"test123\"}"
  echo ""
done
```

6-й запрос должен вернуть `429 Too Many Requests`

### 4.2 Тест лимита логина (10/минуту)

```bash
# Выполните 11 запросов подряд
for i in {1..11}; do
  curl -X POST http://127.0.0.1:8000/token \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "username=test@example.com&password=testpass123"
  echo ""
done
```

11-й запрос должен вернуть `429 Too Many Requests`

## 5. Тестирование Frontend

### 5.1 Обработка 401 ошибок

1. Войдите в приложение
2. Откройте DevTools → Application → Local Storage
3. Удалите или измените `auth_token`
4. Попробуйте выполнить любое действие (создать проект, обновить story)
5. Должно появиться сообщение "Сессия истекла. Пожалуйста, войдите снова."
6. Должен произойти автоматический logout и переход на страницу входа

### 5.2 Тестирование аутентификации

1. Откройте приложение в браузере
2. Должна отобразиться форма входа/регистрации
3. Зарегистрируйте нового пользователя
4. После регистрации должен произойти автоматический вход
5. Проверьте, что отображается email пользователя
6. Выйдите и войдите снова
7. Проверьте, что токен сохраняется в localStorage

## 6. Тестирование Health Checks

### 6.1 Health endpoint

```bash
curl http://127.0.0.1:8000/health
```

Ожидаемый ответ:
```json
{
  "status": "healthy",
  "timestamp": "2025-01-XX..."
}
```

### 6.2 Readiness endpoint

```bash
curl http://127.0.0.1:8000/ready
```

Ожидаемый ответ:
```json
{
  "status": "ready",
  "database": "ok",
  "redis": "ok",
  "timestamp": "2025-01-XX..."
}
```

Если Redis недоступен:
```json
{
  "status": "ready",
  "database": "ok",
  "redis": "unavailable",
  "timestamp": "2025-01-XX..."
}
```

## 7. Тестирование кеширования Redis

### 7.1 Проверка кеша

1. Создайте проект с одинаковыми требованиями дважды
2. Первый запрос должен идти к AI API
3. Второй запрос должен использовать кеш (проверьте логи - не должно быть запроса к AI)

### 7.2 Проверка TTL

Кеш должен храниться 24 часа (86400 секунд). Проверить можно через Redis CLI:
```bash
redis-cli
> TTL ai_map:<hash>
```

## 8. Чек-лист завершения Фазы 1

- [ ] Миграции Alembic работают корректно
- [ ] Все таблицы созданы в БД
- [ ] Регистрация пользователей работает
- [ ] Логин работает и возвращает JWT токен
- [ ] Эндпоинт /me возвращает информацию о пользователе
- [ ] Все защищенные эндпоинты требуют токен (401 без токена)
- [ ] Изоляция данных работает (пользователь видит только свои проекты)
- [ ] Rate limiting работает на всех эндпоинтах
- [ ] Health checks работают
- [ ] Readiness checks работают
- [ ] Redis кеширование работает
- [ ] Frontend обрабатывает 401 ошибки
- [ ] Frontend автоматически делает logout при истечении токена
- [ ] Все CRUD операции проверяют владельца проекта

## Устранение проблем

### Проблема: Миграции не применяются

**Решение:**
1. Проверьте `DATABASE_URL` в `.env`
2. Убедитесь, что PostgreSQL запущен
3. Проверьте права доступа к БД
4. Попробуйте `alembic downgrade -1` затем `alembic upgrade head`

### Проблема: 401 ошибка даже с токеном

**Решение:**
1. Проверьте, что токен не истек (по умолчанию 30 минут)
2. Проверьте `JWT_SECRET_KEY` - должен быть одинаковым при создании и проверке токена
3. Проверьте формат заголовка: `Authorization: Bearer <token>`

### Проблема: Redis не подключается

**Решение:**
1. Проверьте, что Redis запущен: `redis-cli ping`
2. Проверьте `REDIS_URL` в `.env`
3. Приложение должно работать и без Redis (кеширование будет отключено)

### Проблема: Rate limiting не работает

**Решение:**
1. Проверьте, что `slowapi` установлен
2. Проверьте логи - должны быть сообщения о превышении лимита
3. Убедитесь, что используете правильный IP адрес (для локального тестирования)

