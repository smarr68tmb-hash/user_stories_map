# Changelog

## [Unreleased] - Фаза 1: Безопасность и Инфраструктура

### Добавлено (Added)
- **Аутентификация и Авторизация**:
  - JWT (JSON Web Tokens) аутентификация.
  - **Refresh Tokens**: Долгоживущие токены для обновления сессии.
  - Эндпоинты `/register`, `/token` (login), `/refresh`, `/logout`, `/me`.
  - Защита всех API эндпоинтов (требуется валидный токен).
  - Привязка проектов к пользователям (изоляция данных).
  - Модель `User` с хешированием паролей (bcrypt).
  - Frontend: страница входа/регистрации, авто-обновление токена (axios interceptors), авто-logout.

- **База данных и Миграции**:
  - Интеграция с PostgreSQL (через docker-compose).
  - Настройка Alembic для управления миграциями.
  - Таблицы `users` и `refresh_tokens`.
  - Скрипт `migrate.sh` для автоматического запуска миграций.
  - Переход на `email-validator` для проверки email.

- **Тестирование**:
  - Скрипт `backend/test_auth.py` для автоматического E2E тестирования аутентификации.
  - Документация по тестированию `TESTING_PHASE1.md`.

- **Безопасность и Надежность**:
  - Исправлена совместимость версий `bcrypt` и `passlib`.
  - Исправлена валидация JWT (строковый `sub`).
  - Улучшена типизация в FastAPI (`request: Request`) для корректной работы Rate Limiting (`slowapi`).

### Исправлено (Fixed)
- Критическая ошибка инициализации логгера в `main.py`.
- Ошибка подключения к Redis (добавлена проверка перед использованием).
- Frontend: улучшена обработка 401 ошибок и сообщений от сервера.

## [Предыдущие обновления] - Улучшения после ревью

### Критические исправления (✅ Выполнено)

#### Безопасность
- ✅ **CORS**: Изменено с `allow_origins=["*"]` на конфигурируемый список через `ALLOWED_ORIGINS`
- ✅ **Обработка ошибок OpenAI**: Добавлена детальная обработка всех типов ошибок (RateLimit, Timeout, Connection, API)
- ✅ **Валидация входных данных**: Добавлена проверка размера текста (мин 10, макс 10000 символов)

#### Производительность
- ✅ **N+1 проблема**: Исправлена через eager loading с `joinedload` и `subqueryload`
- ✅ **Логирование**: Добавлено структурированное логирование с настраиваемым уровнем

### Улучшения UX (✅ Выполнено)

#### Frontend
- ✅ **Прогресс-бар**: Добавлен визуальный индикатор прогресса генерации
- ✅ **Валидация**: Валидация размера текста с подсчетом символов
- ✅ **Автосохранение**: Автоматическое сохранение черновика в localStorage
- ✅ **Доступность**: Добавлены aria-labels и улучшена навигация с клавиатуры
- ✅ **Обработка ошибок**: Улучшена обработка и отображение ошибок от API

### Инфраструктура (✅ Выполнено)

#### Docker
- ✅ **Docker Compose**: Добавлена полная конфигурация для разработки
- ✅ **Dockerfile для backend**: Оптимизированный образ Python
- ✅ **Dockerfile для frontend**: Образ Node.js для разработки
- ✅ **.dockerignore**: Исключение ненужных файлов из образов

#### Тестирование
- ✅ **Базовые тесты**: Добавлены тесты для основных эндпоинтов
- ✅ **Тесты ошибок**: Тесты обработки различных типов ошибок OpenAI
- ✅ **Pytest конфигурация**: Настроен pytest.ini

#### Скрипты
- ✅ **Улучшен push-to-github.sh**: Проверка незакоммиченных изменений, обработка конфликтов
- ✅ **Улучшен start-backend.sh**: Проверка зависимостей, лучшая обработка ошибок
- ✅ **Улучшен start-frontend.sh**: Проверка версии Node.js, информативные сообщения

### Конфигурация (✅ Выполнено)

- ✅ **.env.example**: Расширен с всеми необходимыми переменными
- ✅ **Переменные окружения**: Все настройки вынесены в переменные окружения
- ✅ **Логирование**: Настраиваемый уровень логирования

## Что осталось для production

### Важно (следующая итерация)
- [ ] Добавить кеширование для OpenAI запросов (Сделано: Redis)
- [ ] Реализовать пагинацию в `/projects` (Сделано)
- [ ] Добавить rate limiting на уровне API (Сделано: slowapi)
- [ ] Настроить мониторинг и алерты (Sentry - в процессе)

### Желательно
- [ ] CI/CD pipeline (GitHub Actions)
- [ ] Автоматические тесты в CI
- [ ] Документация API (OpenAPI/Swagger улучшения)
- [ ] Метрики и аналитика

## Технический долг

- [ ] Рефакторинг: вынести промпты в отдельный файл
- [ ] Добавить типизацию для TypeScript во frontend
- [ ] Оптимизация размера bundle frontend
- [ ] Добавить unit тесты для frontend компонентов
